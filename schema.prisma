datasource db {
  provider = "sqlite"
  url      = "file:dev.db"
}

generator client {
  provider = "cargo prisma"
  output   = "./crates/core/prisma/prisma.rs"
}

model Identity {
  id        String   @id
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  username       String?        @unique
  primaryEmail   String?        @unique
  passwordHash   String?
  LoginProcesses LoginProcess[] // one-to-many relation
  Sessions       Session[] // one-to-many relation
  AuditLog       AuditLog[]
}

model Email {
  email      String    @id @unique
  verified   Boolean
  verifiedAt DateTime?
}

model LinkedAccount {
  id         String @id
  providerId String
}

model LoginProcess {
  id        String   @id
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  identityId  String
  ipAddress   String?
  expiresAt   DateTime
  completed   Boolean  @default(false)
  currentStep String
  magicLink   String?
  Identity    Identity @relation(fields: [identityId], references: [id])
}

model Session {
  id        String    @id
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  revokedAt DateTime?

  refreshToken String
  identityId   String
  Identity     Identity   @relation(fields: [identityId], references: [id])
  AuditLog     AuditLog[]
}

model PublicKey {
  id        String   @id
  createdAt DateTime @default(now())

  // currently only supports ed25519
  type String

  // the node that holds the private key
  nodeId String

  // things that are signed with this key can't be verified after this date
  validUntil DateTime

  // currently unused
  revokedAt DateTime?
}

model Meta {
  key       String   @id @unique
  updatedAt DateTime @updatedAt

  value     String
  valueDate DateTime?
  valueInt  Int?
  valueBool Boolean?
  valueByte Bytes?
}

model AuditLog {
  id        String   @id
  createdAt DateTime @default(now())

  identityId String
  Identity   Identity @relation(fields: [identityId], references: [id])

  sessionId String?
  Session   Session? @relation(fields: [sessionId], references: [id])

  // the node that performed the action
  nodeId String

  // the action that was performed
  action String

  // the target of the action
  targetId String?

  // the type of the target
  targetType String?

  // the data that was changed
  data String?
}
